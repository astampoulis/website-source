machine:
  post:
    - if [[ ! -e ~/.cache/website ]]; then git clone https://$GITHUB_PAGES_TOKEN@github.com/astampoulis/astampoulis.github.io.git ~/.cache/website; fi
    - cd ~/.cache/website && git fetch --all && git reset --hard origin/master

dependencies:
  pre:
    - (cd ~/tmp; wget --output-document=/dev/stdout https://github.com/gohugoio/hugo/releases/download/v0.24/hugo_0.24_Linux-64bit.tar.gz | tar xvzf -) && mv ~/tmp/hugo ~/bin/

  post:
    - hugo

  cache_directories:
    - "~/.cache"

test:
  override:
    - echo "No tests."

deployment:
  master:
    branch: master
    commands:
      - cp -R public/* ~/.cache/website
      - >
        bash -c 'export COMMIT_NAME=$(git log -1 --pretty=%an);
                 export COMMIT_EMAIL=$(git log -1 --pretty=%ae);
                 export COMMIT_MSG=$(git log -1 --pretty=%B);
                 cd ~/.cache/website;
                 git add .;
                 git --no-pager diff;
                 git config user.name "$COMMIT_NAME";
                 git config user.email "$COMMIT_EMAIL";
                 git commit -m "$COMMIT_MSG";
                 git push origin master'

